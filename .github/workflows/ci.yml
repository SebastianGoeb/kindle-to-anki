name: CI
on:
  pull_request:
  push:
    branches:
      - main
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
      - name: Setup
        uses: ./.github/actions/setup
      # - name: Test
      #   uses: actions-rs/cargo@v1
      #   with:
      #     command: test
      #     args: --all-features --no-fail-fast
      #   env:
      #     CARGO_INCREMENTAL: "0"
      #     RUSTFLAGS: "-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Cpanic=abort -Zpanic_abort_tests"
      #     RUSTDOCFLAGS: "-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Cpanic=abort -Zpanic_abort_tests"
      # - id: coverage
      #   uses: actions-rs/grcov@v0.1
      #   with:
      #     config: configs/grcov.yml
      - name: Run cargo-tarpaulin
        uses: actions-rs/tarpaulin@v0.1
        with:
          version: "0.15.0"
          args: "-- --test-threads 1"
      - uses: codecov/codecov-action@v3
        with:
          verbose: true
          fail_ci_if_error: true
